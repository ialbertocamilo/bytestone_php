FROM hyperf/hyperf:8.0-alpine-v3.16-swoole
LABEL maintainer="info@hyperf.io" version="1.0"

##
# ---------- env settings ----------
##
ARG BUILD_ENV=dev

# update mirrors
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# install packages
RUN apk update && apk add --no-cache \
    bash \
    curl \
    wget \
    git \
    zip \
    libzip-dev \
    openssh-client \
    unzip \
    vim \
    inotify-tools \
    procps \
    linux-headers

# install php extensions
RUN docker-php-ext-install pdo_mysql pcntl zip

# instalar xdebug para desarrollo
RUN if [ "$BUILD_ENV" = "dev" ]; then \
        apk add --no-cache $PHPIZE_DEPS \
        && pecl install xdebug \
        && docker-php-ext-enable xdebug; \
    fi

# php config
RUN cd /usr/local/etc/php && \
    { \
        echo "upload_max_filesize=128M"; \
        echo "post_max_size=128M"; \
        echo "memory_limit=1G"; \
        echo "date.timezone=${TIMEZONE:-Asia/Shanghai}"; \
    } | tee conf.d/99-overrides.ini

# xdebug config
RUN if [ "$BUILD_ENV" = "dev" ]; then \
    cd /usr/local/etc/php/conf.d/ && \
    { \
        echo "xdebug.mode=develop,debug"; \
        echo "xdebug.client_host=host.docker.internal"; \
        echo "xdebug.client_port=9003"; \
        echo "xdebug.idekey=PHPSTORM"; \
        echo "xdebug.start_with_request=yes"; \
    } | tee docker-php-ext-xdebug.ini; \
    fi

# workdir
WORKDIR /var/www/html

# composer
COPY ./composer.* ./
RUN if [ "$BUILD_ENV" = "dev" ]; then \
        composer install --ansi --prefer-dist; \
    else \
        composer install --no-dev --no-scripts --no-autoloader --ansi --prefer-dist; \
    fi

# instalar hyperf/watcher para hot reload
RUN if [ "$BUILD_ENV" = "dev" ]; then \
        composer require hyperf/watcher --dev; \
    fi

# set permissions
RUN chmod +x /var/www/html/bin/hyperf.php

# script para iniciar con hot reload si est√° habilitado
COPY ./docker/start-hyperf.sh /usr/local/bin/start-hyperf.sh
RUN chmod +x /usr/local/bin/start-hyperf.sh

EXPOSE 9501

ENTRYPOINT ["/usr/local/bin/start-hyperf.sh"]